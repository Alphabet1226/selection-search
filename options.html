<html>
<head>
<style type="text/css">

body{

	background: #FCF9F9;
	font-family: sans-serif;
}
h4{text-align: left}
p.buttons{
	margin: 0.5em 0;
}


#content{
	margin: 0 auto;
	width: 95%;
	background: #E2EAFF;
	border: 1px solid #D4D4D4;
	-webkit-border-radius: 5px;
	padding: 0.5em;
}
a.delete{
	text-decoration: none;
	color: #CA171A;
	font-weight: bold;
}
#engines{

	width: 100%;
}
#engines th:first-child{
	width: 1em;
}
#engines th:nth-child(2), td:nth-child(2){
	width: 8em;
}
#engines th:last-child, #engines tr td:last-child{
	width: 50px;
	text-align: center;
}
#engines th:nth-child(5){
	width: 75px;
	text-align: center;
}
#engines input{
	width: 100%;
	border: 1px solid #D4D4D4;
}
#style{
	width: 100%;
	height: 15em;
}
#save-buttons{
	margin-top: 2em;
}


#preview{

	float: left;
}
#preview-button{
	margin-left: 2em;
}


#html{
	display: none;
}

#mousebutton{
	margin-top: 2em;
}

.clearb{
	clear: both;
}

.info{
	background:#F6F6F6;
	border: 1px solid #D1D1D1;
	-webkit-border-radius: 5px;
	margin-bottom: 2em;
	padding: 0.5em;
	font-size: 9pt;
	line-height: 1.5;
}

a{
	color: #2E6DAC;
	text-decoration: none;
}
#activator_heading{
	margin-bottom: 0.5em;
}
.theme_def, .activator_options{
	display: none;
}
.activator_options{
	margin-left: 3em;
	margin-bottom: 2em;
}

#customize{
	display: none;
}

#find-engines input[type='text']{
	border: 1px solid #D4D4D4;
}

.drag-target{
	cursor: move;
	float: left;
}

.drag-moving{
	background:#868686;
}

</style>
<script src="jquery-1.4.2.min.js"></script>
<script src="storage.js"></script>
<script src="common.js"></script>
<script src="popup.js"></script>
<script src="reorder.js"></script>
<script>


var ACTIVATORS = {
	'click' : 'Mouse Click',
	'auto' :  'Auto'
}

function addNewEngine(name, url, icon_url, post){


	icon_url = icon_url == undefined ||
				icon_url.length == 0 ? '(Use default)' : icon_url;

	var tr = $('<tr></tr>');

	tr.append($('<td class="drag-target"></td>').css('background', 'url("'+chrome.extension.getURL('move.png')+'") no-repeat center center'));
	tr.append($('<td></td>').append($('<input class="name" type="text" />').val(name)));
	tr.append($('<td></td>').append($('<input class="url" type="text" />').val(url)));
	tr.append($('<td></td>').append($('<input class="icon_url" type="text" />').val(icon_url)));
	tr.append($('<td></td>').append($('<input class="post" type="checkbox" />').attr('checked', post)));
	tr.append($('<td></td>').append($('<a href="#" class="delete">X</a>')));
	tr.find('input.icon_url').focus(function (){

		if ($(this).val() == '(Use default)')
			$(this).val('');

	}).blur(function (){

		if (!$(this).val())
			$(this).val('(Use default)');

	});

	tr.find('a.delete').click(function(){

		$(this).parent().parent().remove();
		return false;
	});


	Reorder.makeMovable(tr);

	$('#engines').append(tr);

}

$(document).ready(function(){

	var popup = new PopUp();


	// The style system has changed.
	// Check if the user has changed the style. If it hasn't we can clear the stored style.
	var stored_style = Storage.getStyle('');
	if (stored_style == $('#old-default-style').val())
		Storage.setStyle('');

	var CURRENT_STYLE = '';

	chrome.extension.sendRequest({}, function(response){

		popup.setOptions(response.options);
		Common.setStyleSheet(response.default_style);
		if(response.extra_style)
			Common.setStyleSheet(response.extra_style);

		for (i in response.searchEngines){
			var en = response.searchEngines[i];

			if(i < 3) // add 3 engines for preview
				popup.addSearchEngine(en);

			addNewEngine(en.name, en.url, en.icon_url, en.post || false);

		}


		if(response.extra_style){

			CURRENT_STYLE= response.extra_style;
			$('#select_theme').prepend('<option selected="selected" value="current_style">&lt;Current Style&gt;</option>');
		}

		$('#preview').append(popup.getForPreview());
		$('#preview-button').append(popup.getButtonForPreview());


		$("input[name='button']").filter("[value="+response.options.button+"]").attr('checked', true);

		$("input[name='newtab']").attr('checked', response.options.newtab);


		$("#select_activator option[value='"+response.options.activator+"']").attr('selected', true);
		$("#select_activator").change();

		$('#select_theme').change();


		$('input[name=remove_icons][value='+response.options.remove_icons+']').attr('checked', true).change();
		$('input[name=use_default_style]').attr('checked', response.options.use_default_style);

	});


	$('#search-icon').append('<img src="'+chrome.extension.getURL('icon16.png')+'" width="16px" height="16px" />');

	$('#new-engine').click(function(){

		addNewEngine('', '', '', false);

		return false;
	});


	$('#save').click(function(){


		var new_engines = [];
		$('#engines tr:gt(0)').each(function(){

			var en = {};

			$(this).find('input').each(function(){
				if ($(this).attr('class') == 'post')
					en[$(this).attr('class')] = $(this).attr('checked');
				else
					en[$(this).attr('class')] = $(this).val();
			});

			if(en.icon_url == '(Use default)')
				delete en.icon_url;
			if(!en.post)
				delete en.post;

			if(en.name && en.url){

// 				if(en.post && en.url.indexOf('{POSTARGS}') == -1)
// 					return;

				new_engines.push(en);
			}
		});


		Storage.setSearchEngines(new_engines);
		Storage.setStyle(jQuery.trim($('#style').val()));

		Storage.setOptions({
			button: parseInt($("input[name='button']:checked").val(), 10),
			newtab: $("input[name='newtab']").is(':checked'),
			activator: $('#select_activator option:selected').first().attr('value'),
			remove_icons:$('input[name=remove_icons]:checked').val(),
			use_default_style: $('input[name=use_default_style]').is(':checked'),
		});

		location.reload();

	});


	$('#restore').click(function(){


		if(confirm("This will delete all your search engines and reset all the changes you have made")){

			Storage.clear();
			location.reload();
		}
		return false;
	});

	$('#update-preview').click(function(e){

		Common.setStyleSheet($('#style').val());

		return false;
	});

	var theme_select = $('#select_theme');

	$('.theme_def').each(function(){
		theme_select.append('<option value="' + $(this).attr('id')+'">'+$(this).attr('name')+'</option>');
	});

	theme_select.change(function(){

		var opt = $('#select_theme option:selected').first();

		var id = opt.attr('value');

		if(id == 'current_style'){
			Common.setStyleSheet(CURRENT_STYLE)
			$("#style").val(CURRENT_STYLE);
			return;
		}

		var css = $('textarea#' + id).val();

		$("#style").val(css);

		Common.setStyleSheet(css);

	});

	for (act in ACTIVATORS){

		var name = ACTIVATORS[act];

		$('#select_activator').append('<option value="' + act + '">'+name+'</option>'); 
	}

	$('#select_activator').change(function(){

		var opt = $('#select_activator option:selected').first();

		$('.activator_options').hide(100);
		$('#activator_' + opt.attr('value')).show(100);

	});

	$('#show_customize').click(function(){
		$('#customize').toggle();

		return false;
	});


	$('#show_html').click(function(){
		$('#html').toggle();
		return false;
	});


	$('input[name=remove_icons]').change(function(){

		if($(this).val() == 'https')
			$('#use_default_style').show(100);
		else
			$('#use_default_style').hide(100);
	});

});
</script>

</head>
<body>

<div id="content">



<p class="info">The search url must start with http:// and contain the special string "%s" which will be replaced with the selected text.
<br />Searches that uses the POST method must contain a {POSTARGS} separator with the post arguments added after it, like this:
http://example.com/search/{POSTARGS}q=%s&amp;type=123
</p>


<table id="engines">
	<tr class="drag-stop">
		<th></th>
		<th>Name</th>
		<th>Search url</th>
		<th>Icon url</th>
		<th>POST</th>
		<th>Delete</th>
	</tr>
</table>
<p class="buttons"><input type="button" value="Add New Search Engine"  id="new-engine" /></p>


<h4>Find Search Engines</h4>

<p class="info">
<strong>CTRL+ALT + click:</strong><br />
You can add new engines by finding a form and holding down CTRL+ALT on the keyboard and clicking inside the input where you would type you search query. <br />
A popup should open where you can edit and save the search engine. This works for a lot of searches, but sometimes it doesn't work.


<br /><br />
<strong>mycroft.mozdev.org:</strong><br />
With the form below you can search for new search engines at mycroft.mozdev.org. Look for this icon: <span id="search-icon"></span> in the search result and click it to add an engine.
The search page must be completely loaded before the icon will show.
Previously opened tabs must be reloaded to show the new engines.</p>

<form id="find-engines" action="http://mycroft.mozdev.org/search-engines.html" method="get">
	<input type="text" name="name" />
	<input type="hidden" name="opensearch" value="yes" />
	<input type="submit" value="Search mycroft.mozdev.org" />
</form>




<h4>Style</h4>

<p id="select_theme_container"><select id="select_theme"></select> <input type="button" id="show_customize" value="Customize" /></p>

<h4>Preview</h4>

<table id="preview-table">
<tr>
	<td><div id="preview"></div></td>
	<td valign="top"><div id="preview-button"></div></td>
</tr>
</table>


<div id="customize">
	<div class="clearb"></div>

	<p class="info" id="style-info">Here you can customize the look of the menu with <a href="http://www.w3schools.com/css/default.asp">Cascading Style Sheets</a>.</p>

	<pre id="html">
&lt;ul id="popup"&gt;
	&lt;li&gt;&lt;input type="text" value="Selected Text" /&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href="#"&gt;&lt;img class="engine-img" src="#" /&gt;&lt;span class="engine-name"&gt;Search engine name&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
	...
&lt;/ul&gt;

&lt;div id="button"&gt;&lt;/div&gt;
	</pre>

	<textarea id="style"></textarea>
	<p class="buttons"><input id="update-preview" type="button" value="Update Preview" /> <input type="button" id="show_html" value="Show HTML" /></p>


</div>


<div class="clearb"></div>


<h4 id="activator_heading">Activate menu</h4>
<select id="select_activator"></select>

<div class="activator_options" id="activator_click">
	<p>Left click: <input type="radio" value="0" name="button" /> Middle click: <input type="radio" value="1" name="button" /></p>
</div>

<div class="activator_options" id="activator_auto">
	<p>A small button will appear when some text is selected and <br />you can open the menu by moving the mouse over the button.<p>
</div>


<p><strong>Open search in new tab:</strong><input type="checkbox" name="newtab" /></p>




<p><strong>Remove Icons:</strong></p>
<p class="info">
On some sites that uses https connection you will get warnings about insecure content when the icons are loaded.
You can remove the icons if you don't want these warnings.
</p>
<p>Always show icons:<input name="remove_icons" type="radio" value="no" /> &nbsp;Always remove icons:<input type="radio" name="remove_icons" value="all" /> &nbsp;Remove icons only on https pages:<input type="radio" name="remove_icons" value="https" /></p>

<div id="use_default_style" style="display: none;">
<p class="info">If you use a icon only style it will not be very usable when the icons are removed. You can check this to get the default style on https pages</p>
Use default style on https pages: <input type="checkbox" name="use_default_style" />
</div>




<p class="buttons" id="save-buttons"><input type="button" id="save" value="Save" /> <input type="button" id="restore" value="Restore defaults" /></p>




<div class="clearb"></div>
</div>



<textarea class="theme_def" name="Default" id="theme_1"></textarea>

<textarea class="theme_def" name="Icons only" id="theme_2">
#popup .engine-name, #popup li:first-child{
 display: none;
}
#popup a, #popup li{
 display: inline; padding: 0.2em;
}
#popup img{
 margin: 0; padding: 0;
}
#popup {
 width: auto;
}
</textarea>


<textarea class="theme_def" name="No selection" id="theme_3">
#popup li:first-child{
 display: none;
}
</textarea>


<textarea class="theme_def" name="Rounded gradient" id="theme_4">
#popup {
 background: -webkit-gradient(linear, left top, left bottom, from(#E0DFDC), to(#B9B8B6));
 -webkit-border-radius: 5px;
}
#popup a:hover{
 background: #E0DFDD;
}
</textarea>

<textarea class="theme_def" name="Transparent" id="theme_5">
#popup {
 opacity: 0.9;
}
</textarea>

<textarea class="theme_def" name="Dark" id="theme_6">
#popup{
 background: #303030;
 border: 1px solid #D1D1D1;
 -webkit-border-radius: 6px;
 -webkit-box-shadow: 0px 1px 5px #979797
}
#popup a, #popup li, #popup .engine-name, #popup input{
 color: #DDDDDD;
}
#popup a:hover{
 background: #595959;
}
</textarea>

<textarea class="theme_def" name="Animations" id="theme_7">
#popup{
 width: 13em;
 -webkit-border-radius: 8px;
}
#popup img{
 -webkit-border-radius: 8px;
 -webkit-transition: all 0.2s ease-in;
}
#popup a:hover img{
 -webkit-border-radius: 2px;
 -webkit-box-shadow: 1px 1px 3px #303030;
  -webkit-transform: rotate(360deg) scale(1.5);
 margin-right: 10px;
}
#popup a{
 -webkit-transition: all 0.2s ease-in;
}
#popup a:hover{
 font-weight: bold;
}
</textarea>

<textarea class="theme_def" name="Animations 2" id="theme_8">
#popup .engine-name, #popup li:first-child{
 display: none;
}
#popup a, #popup li{
 display: inline; padding: 0.2em;
}
#popup img{
 margin: 0; padding: 0;
}
#popup {
 width: auto;
 padding: 0.5em;
 -webkit-border-radius: 5px;
}
#popup img{
 -webkit-border-radius: 8px;
 -webkit-transition: all 0.2s ease-in;
}
#popup a:hover img{
 -webkit-border-radius: 2px;
 -webkit-box-shadow: 1px 1px 3px #303030;
  -webkit-transform: rotate(360deg) scale(1.5);
 margin-right: 3px;
}
#popup a{
 -webkit-transition: all 0.2s ease-in;
}
#popup a:hover{
 font-weight: bold;
 background: none;
}
</textarea>

<!-- The is used to check if someone with an older version of the extension have changed the stylesheet.
 This cant be removed after a while when everybody have updgraded -->
<textarea id="old-default-style" style="display: none;">
#popup{
 width: 12em;
 position: absolute;
 background: #EDECEC;
 border: solid 1px #AEAAA7;
 padding: 0.3em 0.3em;
 font-size: 9pt;
 margin: 0;
 list-style-type: none;
 -webkit-box-shadow: 0px 1px 10px #ccc;
}
#popup li{
 margin: 1px 0;
 padding: 0;
 text-align: left;
 color: #202020;
}
#popup img{
 width: 16px;
 height: 16px;
 vertical-align: middle;
 border:none;
 margin: 0;
 margin-right: 4px;
}
#popup li:first-child {
 overflow: hidden;
 text-overflow:ellipsis;
 white-space:nowrap;
 border-bottom: solid 1px #AEAAA7;
 margin-bottom: 0.5em;
 padding: 0.2em 0.8em;
}
#popup a{
 margin: 1px;
 text-decoration: none;
 color: #202020;
 display: block;
 padding: 0.2em 0.8em;
 -webkit-border-radius: 3px;
}
#popup a:hover{
 background: #96B8E1;
}

</textarea>
</body>
</html>