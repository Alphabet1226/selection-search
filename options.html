<html>
<head>
<style type="text/css">

body{

	background: #FCF9F9;

}
h4{text-align: left}
p.buttons{
	margin: 0.5em 0;
}


#content{
	margin: 0 auto;
	width: 95%;
	background: #E2EAFF;
	border: 1px solid #D4D4D4;
	-webkit-border-radius: 5px;
	padding: 0.5em;
}
a.delete{
	text-decoration: none;
	color: #CA171A;
	font-weight: bold;
}
#engines{

	width: 100%;
}
#engines th:first-child{
	width: 12em;
}
#engines th:last-child, #engines tr td:last-child{
	width: 50px;
	text-align: center;
}
#engines input{
	width: 100%;
	border: 1px solid #D4D4D4;
}
#style{
	width: 100%;
	height: 15em;
}
#save-buttons{
	margin-top: 2em;
}

#restore{
	float: right;
}
#save{
	float: left;
}

#preview{
	margin-right: 1em;
}
#preview-table{
	width: 100%;
}
#preview-table th{
	text-align: left;
}

#mousebutton{
	margin-top: 2em;
}

.clearb{
	clear: both;
}

.info{
	background:#F6F6F6;
	border: 1px solid #D1D1D1;
	-webkit-border-radius: 5px;
	margin-bottom: 2em;
	padding: 0.5em;
	font-size: 9pt;
}

#style-info a{
	color: #2E6DAC;
	text-decoration: none;
}

</style>
<script src="storage.js"></script>
<script src="popup.js"></script>
<script src="jquery-1.4.2.min.js"></script>
<script>



function addNewEngine(name, url, icon_url){


	icon_url = icon_url == undefined ||
				icon_url.length == 0 ? '(Use default)' : icon_url;

	var tr = $('<tr></tr>');

	tr.append('<td><input class="name" type="text" value="'+name+'" /></td>');
	tr.append('<td><input class="url" type="text" value="'+url+'" /></td>');
	tr.append('<td><input class="icon_url" type="text" value="'+icon_url+'" /></td>');
	tr.append('<td><a href="#" class="delete">X</a></td>');


	tr.find('input.icon_url').focus(function (){

		if ($(this).val() == '(Use default)')
			$(this).val('');

	}).blur(function (){

		if (!$(this).val())
			$(this).val('(Use default)');

	});

	tr.find('a.delete').click(function(){

		$(this).parent().parent().remove();
		return false;
	});


	$('#engines').append(tr);

}

$(document).ready(function(){

	var popup = new PopUp();


	// The style system has changed.
	// Check if the user has changed the style. If it hasn't we can clear the stored style.
	var stored_style = Storage.getStyle('');
	if (stored_style == $('#old-default-style').val())
		Storage.setStyle('');



	chrome.extension.sendRequest({}, function(response){
		popup.setDefaultCSSText(response.default_style);
		if(response.extra_style)
			popup.setExtraCSSText(response.extra_style);

		for (i in response.searchEngines){
			var en = response.searchEngines[i];

			if(i < 5) // add 5 engines for preview
				popup.addSearchEngine(en);

			addNewEngine(en.name, en.url, en.icon_url);

		}


		$('#preview').append(popup.getForPreview());
		$('#style').val(response.extra_style);

		$("input[name='button']").filter("[value="+response.button+"]").attr('checked', 'checked');



		if($('#style').val().length == 0){


			var ex = $('<a id="css-example" href="#">Show Example</a>');

			ex.click(function(){

				$('#style').val(
					'#popup {\n' +
						' background: gray;\n' +
						' -webkit-border-radius: 8px;\n'+
					'}\n' +
					'#popup a, #popup li:first-child {\n' +
						' color: white;\n' +
					'}');

				$(this).hide();

				popup.setExtraCSSText($('#style').val());

				return false;
			});

			$('#style-info').append(ex);
		}

	});


	$('#new-engine').click(function(){

		addNewEngine('', '', '');

		return false;
	});


	$('#save').click(function(){


		var new_engines = [];
		$('#engines tr:gt(0)').each(function(){

			var en = {};

			$(this).find('input').each(function(){
				en[$(this).attr('class')] = $(this).val();
			});

			if(en.icon_url == '(Use default)')
				delete en.icon_url;


			if(en.name && en.url)
				new_engines.push(en);
		});


		Storage.setSearchEngines(new_engines);
		Storage.setStyle(jQuery.trim($('#style').val()));
		Storage.setButton($("input[name='button']:checked").val());

		location.reload();

	});

	$('#restore').click(function(){


		if(confirm("This will delete all your search engines and reset all the changes you have made")){

			Storage.clear();

			location.reload();
		}
		return false;
	});

	$('#update-preview').click(function(e){

		popup.setExtraCSSText($('#style').val());

		return false;
	});


});
</script>

</head>
<body>

<div id="content">



<p class="info">The search url must start with http:// and contain the special string "%s" which will be replaced with the selected text.</p>


<table id="engines">
	<tr>
		<th>Name</th>
		<th>Search url</th>
		<th>Icon url</th>
		<th>Delete</th>
	</tr>

</table>
<p class="buttons"><input type="button" value="New Search Engine"  id="new-engine" /></p>



<h4>Style</h4>
<p class="info" id="style-info">Here you can customize the look of the menu with <a href="http://www.w3schools.com/css/default.asp">Cascading Style Sheets</a>. You can see the html structure of the menu below.
Leave it empty to use the default. </p>
<textarea id="style">
</textarea>

<p class="buttons"><input id="update-preview" type="button" value="Update Preview" /></p>
<table id="preview-table">
	<tr>
		<th>Preview</th>
		<th>HTML</th>
	</tr>
	<tr>
<td><div id="preview"></div></td>
<td>
<pre id="html">
&lt;ul id="popup"&gt;
    &lt;li&gt;Selected Text&lt;/li&gt;
    &lt;li&gt;&lt;a href="#"&gt;&lt;img class="engine-img" src="#" /&gt;&lt;span class="engine-name"&gt;Search engine name&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
    ...
&lt;/ul&gt;
</pre>
</td>
</tr>
</table>

<p id="mousebutton"><strong>Activate menu:</strong> Left mouse button: <input type="radio" value="0" name="button" /> Middle mouse button: <input type="radio" value="1" name="button" /></p>


<p class="buttons" id="save-buttons"><input type="button" id="save" value="Save" /> <input type="button" id="restore" value="Restore defaults" /></p>

<div class="clearb"></div>
</div>

<!-- The is used to check if someone with an older version of the extension have changed the stylesheet.
 This cant be removed after a while when everybody have updgraded -->
<textarea id="old-default-style" style="display: none;">
#popup{
 width: 12em;
 position: absolute;
 background: #EDECEC;
 border: solid 1px #AEAAA7;
 padding: 0.3em 0.3em;
 font-size: 9pt;
 margin: 0;
 list-style-type: none;
 -webkit-box-shadow: 0px 1px 10px #ccc;
}
#popup li{
 margin: 1px 0;
 padding: 0;
 text-align: left;
 color: #202020;
}
#popup img{
 width: 16px;
 height: 16px;
 vertical-align: middle;
 border:none;
 margin: 0;
 margin-right: 4px;
}
#popup li:first-child {
 overflow: hidden;
 text-overflow:ellipsis;
 white-space:nowrap;
 border-bottom: solid 1px #AEAAA7;
 margin-bottom: 0.5em;
 padding: 0.2em 0.8em;
}
#popup a{
 margin: 1px;
 text-decoration: none;
 color: #202020;
 display: block;
 padding: 0.2em 0.8em;
 -webkit-border-radius: 3px;
}
#popup a:hover{
 background: #96B8E1;
}

</textarea>
</body>
</html>